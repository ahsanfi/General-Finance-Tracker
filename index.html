<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MA Finance Tracker V7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .loader { border: 3px solid #334155; border-top: 3px solid #38bdf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tab-active { background-color: #2563eb; color: #fff; border-color: transparent; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.3); }
        .calendar-day { min-height: 4.5rem; } 
        @media (min-width: 768px) { .calendar-day { min-height: 7rem; } }
        input, select, textarea { font-size: 16px !important; }
        .preset-btn { @apply px-2 py-2 text-[10px] sm:text-xs font-medium rounded-lg border border-slate-700 text-slate-400 hover:bg-blue-600 hover:text-white hover:border-transparent transition cursor-pointer select-none flex-grow text-center; }
        .preset-active { @apply bg-blue-600 text-white border-transparent shadow-md; }
    </style>
</head>
<body class="bg-slate-950 min-h-screen text-slate-300 pb-20 sm:pb-10 selection:bg-blue-500/30">

    <div id="init-loader" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-slate-950 text-white">
        <div class="loader mb-4"></div>
        <p class="text-sm text-slate-400 animate-pulse">Loading Data...</p>
    </div>

    <div id="pin-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm transition-all">
        <div class="bg-slate-900 rounded-2xl shadow-2xl p-8 w-full max-w-xs border border-slate-800 text-center relative overflow-hidden">
            <h2 class="text-2xl font-bold text-white mb-2">Access</h2>
            <form id="pin-form">
                <input type="password" id="pin-input" inputmode="numeric" pattern="[0-9]*" class="w-full text-center text-4xl tracking-[.5em] px-4 py-4 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:border-blue-500 transition placeholder-slate-700" maxlength="4" required autocomplete="off" placeholder="••••">
                <p id="pin-error" class="text-red-400 text-xs mt-3 min-h-[16px] font-medium"></p>
                <button type="submit" class="w-full mt-6 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition">Unlock</button>
            </form>
        </div>
    </div>

    <div id="main-content" class="hidden w-full max-w-[1600px] mx-auto flex flex-col min-h-screen">
        
        <div class="sticky top-0 z-30 bg-slate-950/90 backdrop-blur-xl border-b border-slate-800 px-4 py-3 sm:py-4 flex justify-between items-center shadow-lg shadow-black/20">
            <div>
                <h1 class="text-lg sm:text-2xl font-bold text-white tracking-tight flex items-center gap-2">
                    <i class="fas fa-wallet text-blue-500"></i> FinTracker
                </h1>
            </div>
            <div class="flex gap-2 sm:gap-3">
                <button id="export-btn" class="bg-slate-800 hover:bg-slate-700 text-slate-300 w-9 h-9 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center transition border border-slate-700"><i class="fas fa-camera"></i></button>
                <button id="logout-btn" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 w-9 h-9 sm:w-10 sm:h-10 rounded-xl flex items-center justify-center transition border border-red-500/20"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div class="px-4 pt-4 pb-2 bg-slate-950 sticky top-[60px] z-20 sm:static sm:z-0">
            <nav class="flex space-x-2 overflow-x-auto no-scrollbar pb-2 sm:justify-center">
                <button id="tab-dashboard" class="tab-btn tab-active px-4 py-2 text-xs sm:text-sm font-medium rounded-full whitespace-nowrap border border-transparent transition-all">Dashboard</button>
                <button id="tab-transactions" class="tab-btn px-4 py-2 text-xs sm:text-sm font-medium rounded-full whitespace-nowrap text-slate-400 border border-slate-800 hover:bg-slate-900 transition-all">List</button>
                <button id="tab-add" class="tab-btn px-4 py-2 text-xs sm:text-sm font-medium rounded-full whitespace-nowrap text-slate-400 border border-slate-800 hover:bg-slate-900 transition-all">Add/Transfer</button>
                <button id="tab-daily" class="tab-btn px-4 py-2 text-xs sm:text-sm font-medium rounded-full whitespace-nowrap text-slate-400 border border-slate-800 hover:bg-slate-900 transition-all">Daily</button>
                <button id="tab-calendar" class="tab-btn px-4 py-2 text-xs sm:text-sm font-medium rounded-full whitespace-nowrap text-slate-400 border border-slate-800 hover:bg-slate-900 transition-all">Calendar</button>
            </nav>
        </div>

        <div id="tab-content" class="p-4 flex-grow">
            
            <div id="view-dashboard" class="tab-view space-y-6">
                 <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-5">
                    
                    <div id="summary-income" class="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex flex-col justify-between min-h-[100px] sm:min-h-[130px] shadow-sm relative overflow-hidden group">
                        <div class="text-[10px] sm:text-xs text-slate-400 uppercase font-bold tracking-wider flex items-center gap-1 mb-2 z-10"><i class="fas fa-arrow-down text-green-500"></i> Income</div>
                        <div class="text-green-400 font-bold text-sm sm:text-2xl truncate z-10 font-mono tracking-tight">...</div>
                        <div class="absolute -bottom-4 -right-4 text-6xl text-green-500/5 z-0 group-hover:scale-110 transition"><i class="fas fa-arrow-down"></i></div>
                    </div>

                    <div id="summary-expense" class="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex flex-col justify-between min-h-[100px] sm:min-h-[130px] shadow-sm relative overflow-hidden group">
                        <div class="text-[10px] sm:text-xs text-slate-400 uppercase font-bold tracking-wider flex items-center gap-1 mb-2 z-10"><i class="fas fa-arrow-up text-red-500"></i> Expense</div>
                        <div class="text-red-400 font-bold text-sm sm:text-2xl truncate z-10 font-mono tracking-tight">...</div>
                        <div class="absolute -bottom-4 -right-4 text-6xl text-red-500/5 z-0 group-hover:scale-110 transition"><i class="fas fa-arrow-up"></i></div>
                    </div>

                    <div id="summary-net" class="bg-slate-900 p-4 rounded-2xl border border-slate-800 flex flex-col justify-between min-h-[100px] sm:min-h-[130px] shadow-sm relative overflow-hidden group">
                        <div class="text-[10px] sm:text-xs text-slate-400 uppercase font-bold tracking-wider flex items-center gap-1 mb-2 z-10"><i class="fas fa-scale-balanced text-slate-400"></i> Net Flow</div>
                        <div class="text-slate-200 font-bold text-sm sm:text-2xl truncate z-10 font-mono tracking-tight">...</div>
                        <div class="absolute -bottom-4 -right-4 text-6xl text-slate-500/5 z-0 group-hover:scale-110 transition"><i class="fas fa-scale-balanced"></i></div>
                    </div>

                    <div id="summary-wealth" class="bg-gradient-to-br from-blue-900 to-slate-900 p-4 rounded-2xl border border-blue-800/50 flex flex-col justify-between min-h-[100px] sm:min-h-[130px] relative overflow-hidden shadow-md">
                        <div class="flex justify-between items-start mb-2 z-10">
                            <div class="text-[10px] sm:text-xs text-blue-200 uppercase font-bold tracking-wider">Net Worth</div>
                            <div class="text-[9px] sm:text-[10px] text-blue-100 bg-blue-800/50 px-2 py-0.5 rounded-md backdrop-blur-md font-mono border border-blue-700/50" id="rate-display">Rate: ...</div>
                        </div>
                        <div id="wealth-display" class="text-white font-bold text-sm sm:text-2xl truncate z-10 font-mono tracking-tight mt-auto">...</div>
                        <div class="absolute -bottom-2 -right-2 text-7xl text-white opacity-5"><i class="fas fa-wallet"></i></div>
                    </div>
                 </div>

                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6">
                    <div class="bg-slate-900 p-4 sm:p-5 rounded-2xl border border-slate-800 shadow-sm flex flex-col h-[400px] lg:h-[450px]">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs sm:text-sm font-semibold text-white flex items-center gap-2"><i class="fas fa-chart-pie text-slate-500"></i> Breakdown</h3>
                            <select id="chart-currency-toggle" class="bg-slate-950 border border-slate-700 text-[10px] sm:text-xs rounded-lg px-2 py-1.5 text-slate-300 focus:border-blue-500 outline-none"><option value="IDR">IDR</option><option value="USD">USD</option></select>
                        </div>
                        <div class="relative flex-grow flex items-center justify-center overflow-hidden">
                             <div class="w-full h-full max-h-[200px] sm:max-h-[250px]"><canvas id="expense-pie-chart"></canvas></div>
                        </div>
                        <div id="expense-details" class="mt-4 space-y-2 overflow-y-auto h-32 pr-2 custom-scroll border-t border-slate-800 pt-2"></div>
                    </div>

                    <div class="bg-slate-900 p-4 sm:p-5 rounded-2xl border border-slate-800 shadow-sm flex flex-col h-[400px] lg:h-[450px]">
                        <h3 class="text-xs sm:text-sm font-semibold text-white mb-4 flex items-center gap-2 flex-shrink-0"><i class="fas fa-wallet text-slate-500"></i> Wallets <span class="text-[9px] text-slate-500 font-normal ml-auto bg-slate-800 px-2 py-1 rounded">Tap USD to convert</span></h3>
                        <div id="account-balances-container" class="grid grid-cols-2 gap-3 overflow-y-auto flex-grow custom-scroll pr-1 content-start"></div>
                    </div>

                    <div class="bg-slate-900 p-4 sm:p-5 rounded-2xl border border-slate-800 shadow-sm md:col-span-2 lg:col-span-1 h-[400px] lg:h-[450px] flex flex-col">
                        <div class="flex justify-between items-center mb-2 flex-shrink-0">
                            <h3 class="text-xs sm:text-sm font-semibold text-white flex items-center gap-2"><i class="fas fa-chart-line text-slate-500"></i> 30-Day Trend</h3>
                        </div>
                        <div class="relative flex-grow w-full"><canvas id="trend-line-chart"></canvas></div>
                    </div>
                 </div>
            </div>

            <div id="view-transactions" class="tab-view hidden space-y-4">
                <div class="bg-slate-900 p-4 sm:p-5 rounded-2xl border border-slate-800 shadow-sm">
                    <div class="grid grid-cols-3 sm:flex sm:flex-wrap gap-2 mb-5">
                        <button class="preset-btn" onclick="applyDatePreset('thisMonth')">This Month</button>
                        <button class="preset-btn" onclick="applyDatePreset('lastMonth')">Last Month</button>
                        <button class="preset-btn" onclick="applyDatePreset('last30')">30 Days</button>
                        <button class="preset-btn" onclick="applyDatePreset('thisYear')">This Year</button>
                        <button class="preset-btn border-red-900/50 text-red-400 hover:bg-red-900/50 col-span-2 sm:col-span-1" onclick="applyDatePreset('clear')">Clear</button>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold ml-1">From</label>
                            <input type="date" id="filter-start" class="bg-slate-800 border border-slate-700 rounded-xl px-3 py-2.5 text-xs w-full text-slate-200 focus:border-blue-500 outline-none transition">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold ml-1">To</label>
                            <input type="date" id="filter-end" class="bg-slate-800 border border-slate-700 rounded-xl px-3 py-2.5 text-xs w-full text-slate-200 focus:border-blue-500 outline-none transition">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold ml-1">Category</label>
                            <select id="filter-cat" class="bg-slate-800 border border-slate-700 rounded-xl px-3 py-2.5 text-xs w-full text-slate-200 focus:border-blue-500 outline-none transition appearance-none"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] text-slate-500 uppercase font-bold ml-1">Wallet</label>
                            <select id="filter-acc" class="bg-slate-800 border border-slate-700 rounded-xl px-3 py-2.5 text-xs w-full text-slate-200 focus:border-blue-500 outline-none transition appearance-none"></select>
                        </div>
                    </div>
                    <input type="text" id="filter-search" placeholder="Search description..." class="bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm w-full text-slate-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition">
                </div>
                
                <div id="mobile-trans-list" class="space-y-3 lg:hidden"></div>

                <div class="hidden lg:block overflow-hidden rounded-2xl border border-slate-800 shadow-sm">
                    <table class="min-w-full divide-y divide-slate-800 bg-slate-900">
                        <thead class="bg-slate-950">
                            <tr>
                                <th class="px-5 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider sortable cursor-pointer hover:text-white" data-sort="date">Date <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-5 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Description</th>
                                <th class="px-5 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Wallet</th>
                                <th class="px-5 py-4 text-left text-xs font-bold text-slate-400 uppercase tracking-wider">Category</th>
                                <th class="px-5 py-4 text-right text-xs font-bold text-slate-400 uppercase tracking-wider sortable cursor-pointer hover:text-white" data-sort="amt">Amount <i class="fas fa-sort ml-1"></i></th>
                                <th class="px-3 py-4 text-center text-xs font-bold text-slate-400 uppercase tracking-wider">Action</th>
                            </tr>
                        </thead>
                        <tbody id="data-body" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-daily" class="tab-view hidden">
                <div class="bg-slate-900 rounded-2xl border border-slate-800 overflow-hidden shadow-sm max-w-4xl mx-auto">
                    <div class="p-4 bg-slate-950/50 border-b border-slate-800"><h3 class="text-sm font-semibold text-slate-200">Daily Expenses</h3></div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-800 text-sm">
                            <thead class="bg-slate-950/30">
                                <tr>
                                    <th class="px-4 sm:px-6 py-4 text-left font-medium text-slate-400 text-xs sm:text-sm">Date</th>
                                    <th class="px-4 sm:px-6 py-4 text-right font-medium text-slate-400 text-xs sm:text-sm">Total IDR</th>
                                    <th class="px-4 sm:px-6 py-4 text-right font-medium text-slate-400 text-xs sm:text-sm">Total USD</th>
                                </tr>
                            </thead>
                            <tbody id="daily-body" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-calendar" class="tab-view hidden">
                <div class="bg-slate-900 p-4 sm:p-6 rounded-2xl border border-slate-800 shadow-sm max-w-5xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <button id="prev-month" class="p-2 sm:p-3 bg-slate-800 rounded-xl hover:bg-slate-700 text-slate-300 transition"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="calendar-header" class="text-lg sm:text-xl font-bold text-white tracking-tight"></h2>
                        <button id="next-month" class="p-2 sm:p-3 bg-slate-800 rounded-xl hover:bg-slate-700 text-slate-300 transition"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs font-bold text-slate-500 mb-3 uppercase tracking-widest">
                        <div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                </div>
            </div>

            <div id="view-add" class="tab-view hidden">
                 <div class="bg-slate-900 p-4 sm:p-6 rounded-2xl border border-slate-800 max-w-2xl mx-auto shadow-xl relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none"></div>

                    <div class="flex justify-between items-center mb-6 relative z-10">
                        <h2 class="text-lg sm:text-xl font-bold text-white flex items-center gap-2" id="form-title"><i class="fas fa-plus-circle text-blue-500"></i> New Entry</h2>
                        <button id="cancel-edit-btn" class="hidden text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg transition">Cancel</button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-6 p-1 bg-slate-950 rounded-xl border border-slate-800">
                        <label class="cursor-pointer relative">
                            <input type="radio" name="entry-type" value="expense" class="peer hidden" checked>
                            <div class="py-2.5 text-center text-xs font-bold rounded-lg text-slate-400 peer-checked:bg-slate-800 peer-checked:text-red-400 peer-checked:shadow-sm transition z-10 relative">EXPENSE</div>
                        </label>
                        <label class="cursor-pointer relative">
                            <input type="radio" name="entry-type" value="income" class="peer hidden">
                            <div class="py-2.5 text-center text-xs font-bold rounded-lg text-slate-400 peer-checked:bg-slate-800 peer-checked:text-green-400 peer-checked:shadow-sm transition z-10 relative">INCOME</div>
                        </label>
                        <label class="cursor-pointer relative">
                            <input type="radio" name="entry-type" value="transfer" class="peer hidden">
                            <div class="py-2.5 text-center text-xs font-bold rounded-lg text-slate-400 peer-checked:bg-slate-800 peer-checked:text-blue-400 peer-checked:shadow-sm transition z-10 relative">TRANSFER</div>
                        </label>
                    </div>

                    <form id="add-entry-form" class="space-y-4 sm:space-y-5 relative z-10">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5">
                            <div class="sm:col-span-2">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">Description</label>
                                <input type="text" id="entry-desc" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition placeholder-slate-600" placeholder="e.g. Lunch" required>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">Date</label>
                                <input type="date" id="entry-date" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition" required>
                            </div>
                            <div id="category-group">
                                <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1.5 ml-1">Category</label>
                                <div class="relative">
                                    <select id="entry-cat" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition appearance-none cursor-pointer"></select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>
                                </div>
                                <input type="text" id="entry-cat-other" placeholder="Type custom category..." class="hidden w-full mt-2 bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 focus:border-blue-500 outline-none">
                            </div>
                        </div>

                        <div class="p-4 bg-slate-950/50 rounded-xl border border-slate-800">
                            <label id="lbl-source-acc" class="block text-[10px] font-bold text-slate-400 uppercase mb-3 tracking-wide">From / Account</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="relative">
                                    <select id="entry-acc-source" class="account-select w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 focus:border-blue-500 focus:outline-none appearance-none"></select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>
                                </div>
                                <div class="flex gap-2">
                                    <select id="entry-curr-source" class="w-[70px] bg-slate-800 border border-slate-700 rounded-xl px-2 py-3 text-sm text-slate-200 text-center focus:border-blue-500 focus:outline-none"><option value="IDR">IDR</option><option value="USD">USD</option></select>
                                    <input type="number" step="any" id="entry-amt-source" placeholder="0" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-slate-200 font-mono text-right text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition placeholder-slate-600" required>
                                </div>
                            </div>
                        </div>

                        <div id="transfer-target-group" class="hidden p-4 bg-slate-950/50 rounded-xl border border-blue-900/30 relative">
                             <div class="absolute left-1/2 -top-3 transform -translate-x-1/2 bg-slate-800 p-1.5 rounded-full border border-slate-700 text-slate-400 z-10"><i class="fas fa-arrow-down"></i></div>
                            <label class="block text-[10px] font-bold text-blue-400 uppercase mb-3 tracking-wide">To Destination</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="relative">
                                    <select id="entry-acc-target" class="account-select w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-sm text-slate-200 focus:border-blue-500 focus:outline-none appearance-none"></select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-4 pointer-events-none text-slate-500"><i class="fas fa-chevron-down text-xs"></i></div>
                                </div>
                                <div class="flex gap-2">
                                    <select id="entry-curr-target" class="w-[70px] bg-slate-800 border border-slate-700 rounded-xl px-2 py-3 text-sm text-slate-200 text-center focus:border-blue-500 focus:outline-none"><option value="IDR">IDR</option><option value="USD">USD</option></select>
                                    <input type="number" step="any" id="entry-amt-target" placeholder="Auto" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 text-slate-200 font-mono text-right text-base focus:ring-2 focus:ring-blue-500 focus:border-blue-500 focus:outline-none transition placeholder-slate-600">
                                </div>
                            </div>
                        </div>

                        <button type="submit" id="submit-btn" class="w-full bg-slate-800 text-slate-300 font-bold py-3.5 sm:py-4 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2 text-base sm:text-lg">
                            Save Transaction
                        </button>
                    </form>
                 </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-900 rounded-2xl p-6 w-full max-w-sm border border-slate-800 text-center shadow-2xl">
            <div class="w-12 h-12 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20"><i class="fas fa-trash-alt text-xl"></i></div>
            <h3 class="font-bold text-white text-lg mb-2">Delete Transaction?</h3>
            <div id="del-item-preview" class="bg-slate-950 p-4 rounded-xl mb-6 text-sm text-slate-300 border border-slate-800 shadow-inner"></div>
            <div class="grid grid-cols-2 gap-3">
                <button id="del-cancel" class="px-4 py-2.5 bg-slate-800 text-white rounded-xl hover:bg-slate-700 font-medium transition">Cancel</button>
                <button id="del-confirm" class="px-4 py-2.5 bg-red-600 text-white rounded-xl hover:bg-red-700 font-medium shadow-lg shadow-red-900/20 transition">Delete</button>
            </div>
        </div>
    </div>
    
    <div id="calendar-detail-modal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm">
        <div class="bg-slate-900 rounded-t-2xl sm:rounded-2xl p-5 w-full max-w-md border-t sm:border border-slate-800 h-[80vh] sm:h-[600px] flex flex-col shadow-2xl">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-800">
                <h3 id="cal-detail-title" class="font-bold text-white text-lg"></h3>
                <button id="cal-close" class="text-slate-400 p-2 hover:bg-slate-800 rounded-full transition"><i class="fas fa-times text-lg"></i></button>
            </div>
            <div id="cal-detail-content" class="flex-grow overflow-y-auto space-y-3 custom-scroll pb-4"></div>
        </div>
    </div>

    <div id="toast" class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-600 z-[80] flex items-center gap-3 min-w-[200px] justify-center transition-all duration-300 translate-y-[-100px] opacity-0"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const SPREADSHEET_ID = "1YRKJgR_VNFCJt3Vgtmkfdf28YZiE44BMNcFg-UGU7hY"; 
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwbehUoJwzW89PN55LIhR71TmMpExcblSIKDPmLLgWJ3iQjGLgSj5h9OxLcmBK6luB9BA/exec";
        const API_KEY = "AIzaSyCNMaR1CCsaGQbcSDzjsTeTCtdc42l35tc";

        let SYSTEM_CONFIG = { exp: [], inc: [], wallets: [], pin: null };
        let masterData = [], itemToDelete = null, sortState = {k:'date',o:'desc'}, calendarDate = new Date(), exchangeRate = 16000; 
        let isEditing = false, editItem = null;

        document.getElementById('entry-date').valueAsDate = new Date();
        loadSystemConfig();

        async function loadSystemConfig() {
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'getSystemConfig' }) });
                const result = await response.json();
                if (result.status === 'success') {
                    SYSTEM_CONFIG = result;
                    const walletOptions = SYSTEM_CONFIG.wallets.map(w => `<option value="${w}">${w}</option>`).join('');
                    document.querySelectorAll('.account-select').forEach(sel => sel.innerHTML = walletOptions);
                    updateCategoryOptions('expense');
                    document.getElementById('init-loader').classList.add('hidden');
                    checkAuth();
                } else throw new Error("Failed");
            } catch (e) { 
                document.getElementById('init-loader').innerHTML = '<p class="text-red-400">Connection Failed. Refresh.</p>';
            }
        }

        function checkAuth() {
            if(sessionStorage.getItem('auth')==='true') { document.getElementById('pin-modal').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); fetchData(); } 
            else document.getElementById('pin-modal').classList.remove('hidden'); 
        }

        document.getElementById('pin-form').addEventListener('submit',e=>{ 
            e.preventDefault(); 
            if(document.getElementById('pin-input').value === SYSTEM_CONFIG.pin){ 
                sessionStorage.setItem('auth','true'); document.getElementById('pin-modal').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); fetchData(); 
            } else document.getElementById('pin-error').textContent="Incorrect PIN";
        });
        document.getElementById('logout-btn').addEventListener('click', ()=>{ sessionStorage.removeItem('auth'); location.reload(); });

        document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', e => switchTab(e.target.id.replace('tab','view'))));
        function switchTab(viewId) {
            document.querySelectorAll('.tab-view').forEach(v=>v.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(t=>{t.classList.remove('tab-active','text-white','bg-blue-600','border-transparent'); t.classList.add('text-slate-400','border-slate-800');});
            document.getElementById(viewId).classList.remove('hidden');
            const btn = document.getElementById(viewId.replace('view','tab'));
            if(btn) { btn.classList.add('tab-active','text-white','bg-blue-600','border-transparent'); btn.classList.remove('text-slate-400','border-slate-800'); }
        }

        window.applyDatePreset = (type) => {
            const now = new Date();
            let start, end;
            if(type === 'thisMonth') { start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); } 
            else if (type === 'lastMonth') { start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); } 
            else if (type === 'last30') { end = new Date(); start = new Date(); start.setDate(now.getDate() - 30); } 
            else if (type === 'thisYear') { start = new Date(now.getFullYear(), 0, 1); end = new Date(now.getFullYear(), 11, 31); } 
            else { document.getElementById('filter-start').value = ''; document.getElementById('filter-end').value = ''; renderAll(); document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('preset-active')); return; }
            document.getElementById('filter-start').value = start.toISOString().split('T')[0]; document.getElementById('filter-end').value = end.toISOString().split('T')[0]; renderAll();
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('preset-active')); if(event) event.target.classList.add('preset-active');
        };

        function updateCategoryOptions(type) {
            const sel = document.getElementById('entry-cat'); sel.innerHTML = '';
            let options = type === 'income' ? SYSTEM_CONFIG.inc : SYSTEM_CONFIG.exp;
            if (!options || options.length === 0) options = ["General"];
            options.forEach(cat => { const o = document.createElement('option'); o.value = cat; o.textContent = cat; sel.appendChild(o); });
            const otherOpt = document.createElement('option'); otherOpt.value = 'Other'; otherOpt.textContent = 'Other...'; sel.appendChild(otherOpt);
            document.getElementById('entry-cat-other').classList.add('hidden');
        }

        const typeRadios = document.getElementsByName('entry-type');
        typeRadios.forEach(r => r.addEventListener('change', () => { updateUIForType(document.querySelector('input[name="entry-type"]:checked').value); }));

        function updateUIForType(val) {
            const tg = document.getElementById('transfer-target-group'), cg = document.getElementById('category-group'), ls = document.getElementById('lbl-source-acc'), btn = document.getElementById('submit-btn');
            if(val === 'transfer') {
                tg.classList.remove('hidden'); cg.classList.add('hidden'); ls.textContent = "FROM / SOURCE";
                btn.innerHTML = `<span>${isEditing ? "Update Transfer" : "Process Transfer"}</span> <i class="fas fa-exchange-alt"></i>`;
                btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 sm:py-4 rounded-xl shadow-lg shadow-blue-900/20 active:scale-[0.98] transition flex items-center justify-center gap-2 text-base sm:text-lg";
            } else {
                tg.classList.add('hidden'); cg.classList.remove('hidden'); ls.textContent = "FROM / ACCOUNT";
                btn.innerHTML = `<span>${isEditing ? "Update Transaction" : "Save Transaction"}</span> <i class="fas fa-check"></i>`;
                updateCategoryOptions(val);
                if(val === 'income') btn.className = isEditing ? "w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3.5 sm:py-4 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2 text-base sm:text-lg" : "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 sm:py-4 rounded-xl shadow-lg shadow-green-900/20 active:scale-[0.98] transition flex items-center justify-center gap-2 text-base sm:text-lg";
                else btn.className = isEditing ? "w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3.5 sm:py-4 rounded-xl shadow-lg active:scale-[0.98] transition flex items-center justify-center gap-2 text-base sm:text-lg" : "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3.5 sm:py-4 rounded-xl shadow-lg shadow-red-900/20 active:scale-[0.98] transition flex items-center justify-center gap-2 text-base sm:text-lg";
            }
        }
        document.getElementById('entry-cat').addEventListener('change', e => document.getElementById('entry-cat-other').classList.toggle('hidden', e.target.value!=='Other'));

        async function fetchData() {
            try {
                const base = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values`;
                const [inc, exp, rateData] = await Promise.all([
                    fetch(`${base}/Income!A2:F?key=${API_KEY}`).then(r=>r.json()),
                    fetch(`${base}/Expenses!A2:F?key=${API_KEY}`).then(r=>r.json()),
                    fetch(`${base}/Expenses!G1?key=${API_KEY}`).then(r=>r.json())
                ]);
                
                masterData = [];
                const parse = (rows, type) => {
                    if(!rows) return;
                    rows.forEach(r => {
                        if(!r[0]) return;
                        let amt = parseFloat(String(r[5] || '0').replace(/,/g, ''));
                        masterData.push({ type, date: r[0], desc: r[1], cat: r[2], acc: r[3], curr: r[4], amt: Math.abs(amt) });
                    });
                };
                parse(inc.values, 'income'); parse(exp.values, 'expense');
                if (rateData.values && rateData.values[0]) exchangeRate = parseFloat(rateData.values[0][0].replace(/,/g, '').replace(/[^\d.]/g, ''));
                
                const cats = [...new Set(masterData.map(d=>d.cat))].sort(), accs = [...new Set(masterData.map(d=>d.acc))].sort();
                document.getElementById('filter-cat').innerHTML = '<option value="all">All Categories</option>' + cats.map(c=>`<option>${c}</option>`).join('');
                document.getElementById('filter-acc').innerHTML = '<option value="all">All Accounts</option>' + accs.map(a=>`<option>${a}</option>`).join('');
                renderAll();
            } catch(e) { showToast("Error loading data: " + e.message, 'error'); }
        }

        function renderAll() {
            const bals = {}; let incIDR=0, expIDR=0, incUSD=0, expUSD=0;
            masterData.forEach(d => {
                const k = `${d.acc}-${d.curr}`;
                if(!bals[k]) bals[k] = {n:d.acc, c:d.curr, v:0};
                if(d.type==='income') { 
                    bals[k].v += d.amt; 
                    if(d.cat !== 'Transfer' && d.cat !== 'Initial Balance') { if(d.curr==='IDR') incIDR+=d.amt; else incUSD+=d.amt; }
                } else { 
                    bals[k].v -= d.amt; 
                    if(d.cat !== 'Transfer') { if(d.curr==='IDR') expIDR+=d.amt; else expUSD+=d.amt; }
                }
            });
            
            // --- UPDATED RENDER LOGIC FOR WALLETS (GRID VIEW) ---
            document.getElementById('account-balances-container').innerHTML = Object.values(bals).sort((a,b)=>a.n.localeCompare(b.n)).map((b, idx) => {
                const isUSD = b.c === 'USD';
                const id = `bal-${idx}`;
                return `
                    <div class="bg-slate-950 p-3 rounded-xl border border-slate-800 hover:border-slate-600 transition flex flex-col justify-center min-h-[70px] relative group">
                        <span class="text-[10px] text-slate-500 uppercase font-bold tracking-wider truncate mb-1" title="${b.n}">${b.n}</span>
                        <span id="${id}" class="font-bold font-mono text-sm truncate ${b.v>=0?'text-blue-400':'text-red-400'} ${isUSD ? 'cursor-pointer' : ''}" onclick="${isUSD ? `toggleCurrency('${id}', ${b.v})` : ''}">
                            ${fmt(b.v, b.c)}
                        </span>
                        ${isUSD ? '<div class="absolute top-2 right-2 text-[8px] text-slate-600 opacity-50"><i class="fas fa-exchange-alt"></i></div>' : ''}
                    </div>
                `;
            }).join('');
            // ---------------------------------------------------

            const totalIncReal = incIDR + (incUSD * exchangeRate);
            const totalExpReal = expIDR + (expUSD * exchangeRate);
            const netCashFlowIDR = totalIncReal - totalExpReal;
            let totalAssetIDR = 0; Object.values(bals).forEach(b => { if(b.c==='IDR') totalAssetIDR+=b.v; if(b.c==='USD') totalAssetIDR+=(b.v*exchangeRate); });
            
            document.querySelector('#summary-income div:nth-child(2)').textContent = fmt(totalIncReal,'IDR');
            document.querySelector('#summary-expense div:nth-child(2)').textContent = fmt(totalExpReal,'IDR');
            document.querySelector('#summary-net div:nth-child(2)').textContent = fmt(netCashFlowIDR,'IDR');
            const netEl = document.querySelector('#summary-net div:nth-child(2)');
            netEl.className = `text-sm sm:text-2xl font-bold truncate z-10 font-mono tracking-tight ${netCashFlowIDR>=0?'text-blue-400':'text-red-400'}`;
            
            document.getElementById('rate-display').textContent = `1 USD = ${fmt(exchangeRate, 'IDR').replace('IDR', '').trim()}`;
            document.getElementById('wealth-display').textContent = new Intl.NumberFormat('en-US',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(totalAssetIDR);

            const s=document.getElementById('filter-search').value.toLowerCase(), start=document.getElementById('filter-start').value, end=document.getElementById('filter-end').value, fCat=document.getElementById('filter-cat').value, fAcc=document.getElementById('filter-acc').value;
            let filtered = masterData.filter(d => {
                if(start && d.date < start) return false; if(end && d.date > end) return false;
                if(fCat!=='all' && d.cat!==fCat) return false; if(fAcc!=='all' && d.acc!==fAcc) return false;
                if(s && !d.desc.toLowerCase().includes(s)) return false; return true;
            }).sort((a,b) => sortState.o==='asc' ? (a[sortState.k]>b[sortState.k]?1:-1) : (a[sortState.k]<b[sortState.k]?1:-1));

            document.getElementById('mobile-trans-list').innerHTML = filtered.map(d => `
                <div class="bg-slate-900 p-4 rounded-xl border border-slate-800 flex justify-between items-center active:bg-slate-800 transition">
                    <div class="flex flex-col max-w-[60%] space-y-1">
                        <span class="text-sm font-bold text-slate-100 truncate">${d.desc}</span>
                        <div class="flex flex-wrap items-center gap-2 text-xs text-slate-400">
                            <span>${d.date.slice(5)}</span> • 
                            <span class="bg-slate-800 px-1.5 py-0.5 rounded text-[10px] uppercase tracking-wide border border-slate-700">${d.acc}</span>
                        </div>
                    </div>
                    <div class="flex flex-col items-end gap-1">
                        <span class="font-bold text-sm ${d.type==='income'?'text-green-400':'text-red-400'}">${d.type==='income'?'+':'-'} ${fmt(d.amt,d.curr)}</span>
                        <div class="flex gap-4">
                            <button class="text-slate-500 hover:text-blue-400 edit-btn p-1" data-item='${JSON.stringify(d)}'><i class="fas fa-pen"></i></button>
                            <button class="text-slate-500 hover:text-red-400 del-btn p-1" data-item='${JSON.stringify(d)}'><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
            if(filtered.length===0) document.getElementById('mobile-trans-list').innerHTML = '<div class="text-center text-slate-500 py-6 text-sm italic">No transactions found</div>';

            document.getElementById('data-body').innerHTML = filtered.map(d => `
                <tr class="hover:bg-slate-800/50 transition border-b border-slate-800 last:border-0 group">
                    <td class="px-5 py-4 text-sm text-slate-400 whitespace-nowrap font-mono">${d.date}</td>
                    <td class="px-5 py-4 text-sm text-slate-200 font-medium">${d.desc}</td>
                    <td class="px-5 py-4 text-sm text-slate-400"><span class="bg-slate-800 border border-slate-700 px-2 py-1 rounded text-xs">${d.acc}</span></td>
                    <td class="px-5 py-4 text-sm text-slate-400">${d.cat}</td>
                    <td class="px-5 py-4 text-sm text-right font-mono font-bold ${d.type==='income'?'text-green-400':'text-red-400'}">${d.type==='income'?'+':'-'} ${fmt(d.amt,d.curr)}</td>
                    <td class="px-3 py-4 text-center">
                        <div class="flex justify-center gap-3 opacity-0 group-hover:opacity-100 transition">
                            <button class="p-1 text-slate-500 hover:text-blue-400 edit-btn transition" data-item='${JSON.stringify(d)}'><i class="fas fa-pencil-alt"></i></button>
                            <button class="p-1 text-slate-500 hover:text-red-400 del-btn transition" data-item='${JSON.stringify(d)}'><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                </tr>
            `).join('');
            if(filtered.length===0) document.getElementById('data-body').innerHTML = '<tr><td colspan="6" class="text-center py-10 text-slate-500 text-sm italic">No data found</td></tr>';

            renderDaily(masterData); renderCalendar(masterData); updateChart(masterData); updateTrendChart(masterData);
        }

        window.toggleCurrency = (id, usdVal) => {
            const el = document.getElementById(id);
            if(el.textContent.includes('$')) { const idrVal = usdVal * exchangeRate; el.textContent = fmt(idrVal, 'IDR'); el.classList.add('text-yellow-400'); } else { el.textContent = fmt(usdVal, 'USD'); el.classList.remove('text-yellow-400'); }
        };

        function renderDaily(data) {
            const dly={}; data.filter(d=>d.type==='expense'&&d.cat!=='Transfer').forEach(d=>{ if(!dly[d.date]) dly[d.date]={idr:0,usd:0}; if(d.curr==='IDR') dly[d.date].idr+=d.amt; else dly[d.date].usd+=d.amt; });
            document.getElementById('daily-body').innerHTML = Object.keys(dly).sort().reverse().map(dt => `<tr class="hover:bg-slate-800/50 border-b border-slate-800 last:border-0"><td class="px-4 sm:px-6 py-4 text-xs sm:text-sm text-slate-300 font-medium font-mono">${dt}</td><td class="px-4 sm:px-6 py-4 text-xs sm:text-sm text-right text-red-400 font-mono">${dly[dt].idr>0?fmt(dly[dt].idr,'IDR'):'-'}</td><td class="px-4 sm:px-6 py-4 text-xs sm:text-sm text-right text-red-400 font-mono">${dly[dt].usd>0?fmt(dly[dt].usd,'USD'):'-'}</td></tr>`).join('');
        }

        function renderCalendar(data) {
            const g = document.getElementById('calendar-grid'); g.innerHTML = ''; const y=calendarDate.getFullYear(), m=calendarDate.getMonth(); document.getElementById('calendar-header').textContent = calendarDate.toLocaleString('default',{month:'long',year:'numeric'});
            for(let i=0; i<new Date(y,m,1).getDay(); i++) g.appendChild(document.createElement('div'));
            for(let d=1; d<=new Date(y,m+1,0).getDate(); d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, items = data.filter(i=>i.date===dateStr), el = document.createElement('div');
                el.className = "calendar-day bg-slate-950/50 border border-slate-800 rounded-lg p-1.5 flex flex-col items-center justify-start hover:bg-slate-800 hover:border-slate-600 transition active:scale-[0.98] cursor-pointer"; 
                el.innerHTML = `<span class="text-[10px] text-slate-500 mb-1 font-bold">${d}</span>`;
                if(items.length>0) { 
                    el.innerHTML += `<div class="flex gap-1 mt-auto pb-1">${items.some(x=>x.type==='income')?'<div class="h-2 w-2 rounded-full bg-green-500 shadow-sm shadow-green-500/50"></div>':''}${items.some(x=>x.type==='expense')?'<div class="h-2 w-2 rounded-full bg-red-500 shadow-sm shadow-red-500/50"></div>':''}</div>`; 
                    el.onclick = () => { 
                        document.getElementById('cal-detail-title').textContent = new Date(dateStr).toLocaleDateString('en-US', {weekday:'long', year:'numeric', month:'long', day:'numeric'}); 
                        document.getElementById('cal-detail-content').innerHTML = items.map(x=>`<div class="flex justify-between items-center p-4 bg-slate-950 rounded-xl border border-slate-800 mb-2"><div><div class="text-sm text-white font-bold">${x.desc}</div><div class="text-xs text-slate-500 mt-0.5">${x.cat} • ${x.acc}</div></div><div class="${x.type==='income'?'text-green-400':'text-red-400'} font-mono text-sm font-bold">${fmt(x.amt,x.curr)}</div></div>`).join(''); 
                        document.getElementById('calendar-detail-modal').classList.remove('hidden'); 
                    }; 
                }
                g.appendChild(el);
            }
        }
        document.getElementById('prev-month').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(masterData); });
        document.getElementById('next-month').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(masterData); });
        document.getElementById('cal-close').addEventListener('click', ()=>document.getElementById('calendar-detail-modal').classList.add('hidden'));

        let myChart;
        function updateChart(data) {
            const curr = document.getElementById('chart-currency-toggle').value; const exps = data.filter(d=>d.type==='expense'&&d.curr===curr&&d.cat!=='Transfer'); const totals={}; exps.forEach(d=>totals[d.cat]=(totals[d.cat]||0)+d.amt);
            const ctx=document.getElementById('expense-pie-chart').getContext('2d'); if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {type:'doughnut',data:{labels:Object.keys(totals),datasets:[{data:Object.values(totals),backgroundColor:['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#3b82f6','#a855f7','#ec4899','#6366f1'],borderWidth:0, hoverOffset: 4}]},options:{plugins:{legend:{display:false}},cutout:'75%', responsive: true, maintainAspectRatio: false}});
            document.getElementById('expense-details').innerHTML = Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<div class="flex justify-between text-xs py-2 border-b border-slate-800 last:border-0"><span class="text-slate-300 font-medium">${k}</span><span class="font-mono text-slate-100">${fmt(v,curr)}</span></div>`).join('');
        }

        let trendChart;
        function updateTrendChart(data) {
            const ctx = document.getElementById('trend-line-chart').getContext('2d');
            if (trendChart) trendChart.destroy();
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            const rawData = data.filter(d => d.type === 'expense' && d.cat !== 'Transfer' && new Date(d.date) >= thirtyDaysAgo);
            const dailyTotals = {}; rawData.forEach(d => { const date = d.date; const amountIDR = d.curr === 'USD' ? d.amt * exchangeRate : d.amt; dailyTotals[date] = (dailyTotals[date] || 0) + amountIDR; });
            const sortedDates = Object.keys(dailyTotals).sort(); const values = sortedDates.map(date => dailyTotals[date]);
            const labels = sortedDates.map(d => { const dateObj = new Date(d); return dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); });

            trendChart = new Chart(ctx, {
                type: 'line',
                data: { labels: labels, datasets: [{ label: 'Total Expenses (IDR)', data: values, borderColor: '#3b82f6', backgroundColor: (context) => { const ctx = context.chart.ctx; const gradient = ctx.createLinearGradient(0, 0, 0, 200); gradient.addColorStop(0, 'rgba(59, 130, 246, 0.4)'); gradient.addColorStop(1, 'rgba(59, 130, 246, 0)'); return gradient; }, borderWidth: 2, tension: 0.4, pointRadius: 3, pointBackgroundColor: '#1e293b', pointBorderColor: '#3b82f6', pointBorderWidth: 2, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } }, y: { grid: { color: '#334155', borderDash: [4, 4], drawBorder: false }, ticks: { color: '#64748b', font: { size: 10 }, callback: function(value) { return value >= 1000000 ? (value/1000000).toFixed(1) + 'M' : (value/1000).toFixed(0) + 'k'; } } } } }
            });
        }

        document.getElementById('add-entry-form').addEventListener('submit', e => {
            e.preventDefault(); const btn=document.getElementById('submit-btn'); const origTxt=btn.innerHTML; btn.innerHTML='<div class="loader w-5 h-5 border-2"></div>'; btn.disabled=true;
            const type = document.querySelector('input[name="entry-type"]:checked').value, date=document.getElementById('entry-date').value, desc=document.getElementById('entry-desc').value;
            let payload = {};

            if(isEditing) {
                let cat = document.getElementById('entry-cat').value; if(cat==='Other') cat = document.getElementById('entry-cat-other').value;
                payload = { 
                    action: 'edit', 
                    oldSheetName: editItem.type==='income'?'Income':'Expenses', 
                    originalData: editItem,
                    newSheetName: type==='income'?'Income':'Expenses',
                    newData: { date, description: desc, category: cat, account: document.getElementById('entry-acc-source').value, currency: document.getElementById('entry-curr-source').value, amount: Math.abs(parseFloat(document.getElementById('entry-amt-source').value)) }
                };
            } else {
                if(type === 'transfer') {
                    const fromAmt = parseFloat(document.getElementById('entry-amt-source').value), toAmtInput = document.getElementById('entry-amt-target').value, toAmt = toAmtInput ? parseFloat(toAmtInput) : fromAmt;
                    if(document.getElementById('entry-acc-source').value === document.getElementById('entry-acc-target').value && document.getElementById('entry-curr-source').value === document.getElementById('entry-curr-target').value) { showToast("Source and Target are identical!", 'error'); btn.innerHTML=origTxt; btn.disabled=false; return; }
                    payload = { action: 'transfer', date, description: desc, fromAccount: document.getElementById('entry-acc-source').value, fromCurrency: document.getElementById('entry-curr-source').value, fromAmount: Math.abs(fromAmt), toAccount: document.getElementById('entry-acc-target').value, toCurrency: document.getElementById('entry-curr-target').value, toAmount: Math.abs(toAmt) };
                } else {
                    let cat = document.getElementById('entry-cat').value; if(cat==='Other') cat = document.getElementById('entry-cat-other').value;
                    payload = { action: 'add', sheetName: type==='income'?'Income':'Expenses', date, description: desc, category: cat, account: document.getElementById('entry-acc-source').value, currency: document.getElementById('entry-curr-source').value, amount: Math.abs(parseFloat(document.getElementById('entry-amt-source').value)) };
                }
            }

            fetch(WEB_APP_URL, {method:'POST', body:JSON.stringify(payload)}).then(r=>r.json()).then(d => {
                if(d.status==='success') { showToast(d.message, 'success'); resetForm(); setTimeout(fetchData, 1500); } else throw new Error(d.message);
            }).catch(e => showToast("Error: "+e.message, 'error')).finally(() => { btn.innerHTML=origTxt; btn.disabled=false; });
        });

        function resetForm() {
            document.getElementById('add-entry-form').reset(); document.getElementById('entry-date').valueAsDate = new Date();
            isEditing=false; editItem=null; document.getElementById('form-title').innerHTML='<i class="fas fa-plus-circle text-blue-500"></i> New Entry'; document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.querySelector('input[name="entry-type"][value="expense"]').checked = true; document.querySelector('input[name="entry-type"][value="expense"]').dispatchEvent(new Event('change'));
        }
        document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);

        document.addEventListener('click', e => {
            const btnEdit = e.target.closest('.edit-btn'), btnDel = e.target.closest('.del-btn');
            
            if(btnDel) { 
                itemToDelete = JSON.parse(btnDel.dataset.item); 
                document.getElementById('del-item-preview').innerHTML = `<div class="font-bold text-white text-base">${itemToDelete.desc}</div><div class="mt-1 ${itemToDelete.type==='income'?'text-green-400':'text-red-400'} font-mono text-lg">${fmt(itemToDelete.amt, itemToDelete.curr)}</div><div class="text-xs text-slate-500 mt-2">${itemToDelete.date} • ${itemToDelete.acc}</div>`; 
                document.getElementById('delete-modal').classList.remove('hidden'); 
            }
            
            if(btnEdit) {
                const item = JSON.parse(btnEdit.dataset.item);
                if(item.cat === 'Transfer') { showToast("Please delete and recreate transfer.", 'error'); return; }
                isEditing=true; editItem=item; 
                document.getElementById('form-title').innerHTML='<i class="fas fa-edit text-orange-500"></i> Edit Entry'; document.getElementById('cancel-edit-btn').classList.remove('hidden'); switchTab('view-add');
                document.querySelector(`input[name="entry-type"][value="${item.type}"]`).checked = true; updateUIForType(item.type);
                document.getElementById('entry-desc').value = item.desc; document.getElementById('entry-date').value = item.date; 
                const catSelect = document.getElementById('entry-cat'); if([...catSelect.options].map(o=>o.value).includes(item.cat)) catSelect.value = item.cat; else { catSelect.value = 'Other'; document.getElementById('entry-cat-other').classList.remove('hidden'); document.getElementById('entry-cat-other').value = item.cat; }
                document.getElementById('entry-acc-source').value = item.acc; document.getElementById('entry-curr-source').value = item.curr; document.getElementById('entry-amt-source').value = item.amt;
            }
        });

        document.getElementById('del-cancel').addEventListener('click', ()=>document.getElementById('delete-modal').classList.add('hidden'));
        document.getElementById('del-confirm').addEventListener('click', ()=>{
            const btn = document.getElementById('del-confirm'); const origTxt = btn.textContent; btn.innerHTML='<div class="loader w-4 h-4 border-2"></div>';
            fetch(WEB_APP_URL, {
                method:'POST', 
                body:JSON.stringify({ action:'delete', sheetName: itemToDelete.type==='income'?'Income':'Expenses', originalData: itemToDelete })
            }).then(r=>r.json()).then(d => {
                document.getElementById('delete-modal').classList.add('hidden'); btn.textContent=origTxt; if(d.status==='success') { showToast("Deleted successfully", 'success'); fetchData(); } else showToast(d.message, 'error');
            });
        });

        function fmt(n, c) { return new Intl.NumberFormat('en-US', {style:'currency',currency:c,minimumFractionDigits:0,maximumFractionDigits:2}).format(n); }
        function showToast(m, type) { 
            const t=document.getElementById('toast'); 
            t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl border z-[90] flex items-center gap-3 min-w-[200px] justify-center transition-all duration-300 translate-y-0 opacity-100 ${type==='error'?'bg-red-900/95 border-red-700 text-red-100':'bg-slate-800/95 border-slate-600 text-slate-100'}`;
            t.innerHTML = `${type==='error'?'<i class="fas fa-exclamation-circle text-lg"></i>':'<i class="fas fa-check-circle text-green-400 text-lg"></i>'} <span class="font-medium">${m}</span>`;
            t.classList.remove('hidden'); 
            setTimeout(()=>{ t.classList.add('translate-y-[-100px]', 'opacity-0'); setTimeout(()=>t.classList.add('hidden'),300); }, 3000); 
        }
        
        ['filter-start','filter-end','filter-cat','filter-acc','filter-search'].forEach(i => document.getElementById(i).addEventListener('input', renderAll));
        document.getElementById('chart-currency-toggle').addEventListener('change', ()=>updateChart(masterData));
        document.querySelectorAll('.sortable').forEach(s => s.addEventListener('click', e => { sortState.k = e.target.dataset.sort; sortState.o = sortState.o==='asc'?'desc':'asc'; renderAll(); }));
        document.getElementById('export-btn').addEventListener('click', async () => { 
            const el = document.getElementById('main-content'); // Capture full content
            const c = await html2canvas(el, {backgroundColor:'#020617', scale:2, ignoreElements: (e) => e.id === 'toast' || e.id === 'init-loader' }); 
            const a = document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='finance_dashboard.png'; a.click(); 
        });
    });
    </script>
</body>
</html>
