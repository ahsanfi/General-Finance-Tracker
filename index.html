<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finance Tracker Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        
        /* Hide scrollbar for tabs but keep functionality */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .loader { border: 3px solid #334155; border-top: 3px solid #38bdf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tab-active { background-color: #2563eb; color: #fff; border-color: transparent; }
        .calendar-day { min-height: 4rem; } 
        @media (min-width: 640px) { .calendar-day { min-height: 6rem; } }
        .sortable { cursor: pointer; user-select: none; }
        
        /* Prevent iOS zoom on inputs */
        input, select { font-size: 16px !important; }
        @media (min-width: 640px) { input, select { font-size: 0.875rem !important; } }
    </style>
</head>
<body class="bg-slate-950 min-h-screen text-slate-300 pb-20 sm:pb-10">

    <div id="init-loader" class="fixed inset-0 z-[60] flex flex-col items-center justify-center bg-slate-950 text-white">
        <div class="loader mb-4"></div>
        <p class="text-sm text-slate-400">Loading System Config...</p>
    </div>

    <div id="pin-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/95 backdrop-blur-sm">
        <div class="bg-slate-800 rounded-xl shadow-2xl p-6 w-full max-w-xs border border-slate-700 text-center">
            <h2 class="text-xl font-bold text-slate-100 mb-4">Secure Access</h2>
            <form id="pin-form">
                <input type="password" id="pin-input" inputmode="numeric" pattern="[0-9]*" class="w-full text-center text-3xl tracking-[.5em] px-3 py-3 bg-slate-700 border border-slate-600 rounded-lg text-slate-100 focus:outline-none focus:border-blue-500 transition mb-4" maxlength="4" required autocomplete="off">
                <p id="pin-error" class="text-red-400 text-sm mb-4 min-h-[20px]"></p>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-500 active:scale-95 transition">Enter</button>
            </form>
        </div>
    </div>

    <div id="main-content" class="hidden w-full max-w-7xl mx-auto p-3 sm:p-6">
        
        <div class="flex justify-between items-center mb-6 sticky top-0 bg-slate-950/90 backdrop-blur z-20 py-2 border-b border-slate-800 sm:static sm:bg-transparent sm:border-none">
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-slate-100">Finance Tracker</h1>
                <p class="text-xs sm:text-sm text-slate-500 uppercase tracking-wider">Dashboard</p>
            </div>
            <div class="flex gap-2">
                <button id="export-btn" class="bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg text-xs sm:text-sm transition border border-slate-700">Export</button>
                <button id="logout-btn" class="bg-red-900/20 hover:bg-red-900/40 text-red-400 p-2 rounded-lg transition border border-red-900/30"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <div class="mb-6 border-b border-slate-800">
            <nav class="flex space-x-2 overflow-x-auto no-scrollbar pb-2">
                <button id="tab-dashboard" class="tab-btn tab-active px-4 py-2 text-sm font-medium rounded-t-lg border-b-2 border-blue-500 whitespace-nowrap">Dashboard</button>
                <button id="tab-transactions" class="tab-btn px-4 py-2 text-sm font-medium rounded-t-lg text-slate-400 hover:text-white transition whitespace-nowrap">Transactions</button>
                <button id="tab-add" class="tab-btn px-4 py-2 text-sm font-medium rounded-t-lg text-slate-400 hover:text-white transition whitespace-nowrap">Add / Transfer</button>
                <button id="tab-daily" class="tab-btn px-4 py-2 text-sm font-medium rounded-t-lg text-slate-400 hover:text-white transition whitespace-nowrap">Daily</button>
                <button id="tab-calendar" class="tab-btn px-4 py-2 text-sm font-medium rounded-t-lg text-slate-400 hover:text-white transition whitespace-nowrap">Calendar</button>
            </nav>
        </div>

        <div id="tab-content">
            
            <div id="view-dashboard" class="tab-view space-y-6">
                 <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                    <div id="summary-income" class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col justify-center h-24 sm:h-28">
                        <div class="text-[10px] sm:text-xs text-slate-400 uppercase font-bold tracking-wider mb-1 sm:mb-2">Total Income</div>
                        <div class="text-green-400 font-bold text-sm sm:text-xl truncate">...</div>
                    </div>
                    <div id="summary-expense" class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col justify-center h-24 sm:h-28">
                        <div class="text-[10px] sm:text-xs text-slate-400 uppercase font-bold tracking-wider mb-1 sm:mb-2">Total Expense</div>
                        <div class="text-red-400 font-bold text-sm sm:text-xl truncate">...</div>
                    </div>
                    <div id="summary-net" class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex flex-col justify-center h-24 sm:h-28">
                        <div class="text-[10px] sm:text-xs text-slate-400 uppercase font-bold tracking-wider mb-1 sm:mb-2">Net Flow</div>
                        <div class="text-slate-200 font-bold text-sm sm:text-xl truncate">...</div>
                    </div>
                    <div id="summary-wealth" class="bg-gradient-to-br from-blue-900 to-slate-800 p-4 rounded-xl border border-blue-800 flex flex-col justify-center h-24 sm:h-28 relative overflow-hidden">
                        <div class="flex justify-between items-start z-10 mb-1 sm:mb-2">
                            <div class="text-[10px] sm:text-xs text-blue-200 uppercase font-bold tracking-wider">Net Worth</div>
                            <div class="text-[8px] sm:text-[10px] text-blue-100 bg-black/20 px-1.5 py-0.5 rounded backdrop-blur-md">Rate: ...</div>
                        </div>
                        <div class="text-white font-bold text-sm sm:text-xl truncate z-10">...</div>
                        <div class="absolute -bottom-2 -right-2 text-6xl sm:text-7xl text-white opacity-5"><i class="fas fa-wallet"></i></div>
                    </div>
                 </div>

                 <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-slate-800 p-4 sm:p-5 rounded-xl border border-slate-700 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xs sm:text-sm font-bold text-slate-200 uppercase">Expense Breakdown</h3>
                            <select id="chart-currency-toggle" class="bg-slate-900 border border-slate-600 text-xs rounded px-2 py-1 text-slate-400 focus:outline-none"><option value="IDR">IDR</option><option value="USD">USD</option></select>
                        </div>
                        <div class="relative h-48 sm:h-64 w-full flex justify-center"><canvas id="expense-pie-chart"></canvas></div>
                        <div id="expense-details" class="mt-4 space-y-2 max-h-48 overflow-y-auto pr-2 custom-scroll"></div>
                    </div>
                    
                    <div class="bg-slate-800 p-4 sm:p-5 rounded-xl border border-slate-700 lg:col-span-2">
                        <h3 class="text-xs sm:text-sm font-bold text-slate-200 uppercase mb-4">Wallet Balances <span class="text-[10px] sm:text-xs text-slate-500 font-normal ml-2 text-transform-none">(Click USD to convert)</span></h3>
                        <div id="account-balances-container" class="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4 max-h-[400px] overflow-y-auto"></div>
                    </div>
                 </div>
            </div>

            <div id="view-transactions" class="tab-view hidden">
                <div class="bg-slate-800 p-4 sm:p-5 rounded-xl border border-slate-700 mb-4">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar mb-4 pb-1">
                        <button class="preset-btn whitespace-nowrap" onclick="applyDatePreset('thisMonth')">This Month</button>
                        <button class="preset-btn whitespace-nowrap" onclick="applyDatePreset('lastMonth')">Last Month</button>
                        <button class="preset-btn whitespace-nowrap" onclick="applyDatePreset('last30')">30 Days</button>
                        <button class="preset-btn whitespace-nowrap" onclick="applyDatePreset('thisYear')">This Year</button>
                        <button class="preset-btn whitespace-nowrap" onclick="applyDatePreset('clear')">Clear</button>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-5 gap-3 items-end">
                        <input type="date" id="filter-start" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-xs sm:text-sm text-slate-300 w-full">
                        <input type="date" id="filter-end" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-xs sm:text-sm text-slate-300 w-full">
                        <select id="filter-cat" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-xs sm:text-sm text-slate-300 w-full"></select>
                        <select id="filter-acc" class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-xs sm:text-sm text-slate-300 w-full"></select>
                        <input type="text" id="filter-search" placeholder="Search..." class="bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-xs sm:text-sm text-slate-300 w-full">
                    </div>
                </div>
                
                <div class="overflow-x-auto rounded-xl border border-slate-800 bg-slate-900 shadow-xl">
                    <table class="min-w-full divide-y divide-slate-800">
                        <thead class="bg-slate-950">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider whitespace-nowrap">Date</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider whitespace-nowrap">Description</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider whitespace-nowrap">Account</th>
                                <th class="px-4 py-3 text-left text-xs font-bold text-slate-400 uppercase tracking-wider whitespace-nowrap">Category</th>
                                <th class="px-4 py-3 text-right text-xs font-bold text-slate-400 uppercase tracking-wider whitespace-nowrap">Amount</th>
                                <th class="px-4 py-3 text-center text-xs font-bold text-slate-400 uppercase tracking-wider whitespace-nowrap">Act</th>
                            </tr>
                        </thead>
                        <tbody id="data-body" class="divide-y divide-slate-800"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-daily" class="tab-view hidden">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <h3 class="font-semibold text-slate-200 mb-4">Daily Expenses</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-700">
                            <thead class="bg-slate-700"><tr><th class="px-6 py-3 text-left text-xs font-medium text-slate-400 whitespace-nowrap">Date</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-400 whitespace-nowrap">Total (IDR)</th><th class="px-6 py-3 text-right text-xs font-medium text-slate-400 whitespace-nowrap">Total (USD)</th></tr></thead>
                            <tbody id="daily-body" class="divide-y divide-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="view-calendar" class="tab-view hidden">
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <div class="flex items-center justify-between mb-4">
                        <button id="prev-month" class="p-2 rounded hover:bg-slate-600 bg-slate-700"><i class="fas fa-chevron-left"></i></button>
                        <h2 id="calendar-header" class="text-lg font-bold text-slate-100"></h2>
                        <button id="next-month" class="p-2 rounded hover:bg-slate-600 bg-slate-700"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="grid grid-cols-7 text-center text-xs text-slate-400 mb-2"><div>S</div><div>M</div><div>T</div><div>W</div><div>T</div><div>F</div><div>S</div></div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
                </div>
            </div>

            <div id="view-add" class="tab-view hidden">
                 <div class="bg-slate-800 p-4 sm:p-6 rounded-xl border border-slate-700 max-w-3xl mx-auto shadow-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-slate-100" id="form-title">New Transaction</h2>
                        <button id="cancel-edit-btn" class="hidden text-xs bg-slate-700 text-slate-300 px-3 py-1.5 rounded hover:bg-slate-600">Cancel</button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mb-6 p-1 bg-slate-900 rounded-lg">
                        <label class="cursor-pointer"><input type="radio" name="entry-type" value="expense" class="peer hidden" checked><div class="py-2 text-center text-xs sm:text-sm font-bold rounded-md text-slate-400 peer-checked:bg-slate-800 peer-checked:text-red-400 peer-checked:shadow transition">Expense</div></label>
                        <label class="cursor-pointer"><input type="radio" name="entry-type" value="income" class="peer hidden"><div class="py-2 text-center text-xs sm:text-sm font-bold rounded-md text-slate-400 peer-checked:bg-slate-800 peer-checked:text-green-400 peer-checked:shadow transition">Income</div></label>
                        <label class="cursor-pointer"><input type="radio" name="entry-type" value="transfer" class="peer hidden"><div class="py-2 text-center text-xs sm:text-sm font-bold rounded-md text-slate-400 peer-checked:bg-slate-800 peer-checked:text-blue-400 peer-checked:shadow transition">Transfer</div></label>
                    </div>

                    <form id="add-entry-form" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2"><label class="block text-xs text-slate-400 mb-1 font-bold uppercase">Description</label><input type="text" id="entry-desc" placeholder="Details..." class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-blue-500" required></div>
                            <div><label class="block text-xs text-slate-400 mb-1 font-bold uppercase">Date</label><input type="date" id="entry-date" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-blue-500" required></div>
                            <div id="category-group"><label class="block text-xs text-slate-400 mb-1 font-bold uppercase">Category</label><select id="entry-cat" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-blue-500 appearance-none"></select><input type="text" id="entry-cat-other" placeholder="New Category" class="hidden w-full mt-2 bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200"></div>
                        </div>
                        <div class="p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
                            <label id="lbl-source-acc" class="block text-xs font-bold text-slate-500 uppercase mb-3">Account Details</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><select id="entry-acc-source" class="account-select w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-blue-500"></select></div>
                                <div class="flex gap-2">
                                    <div class="w-1/3"><select id="entry-curr-source" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-2 py-3 text-slate-200 text-center"><option value="IDR">IDR</option><option value="USD">USD</option></select></div>
                                    <div class="w-2/3"><input type="number" step="any" id="entry-amt-source" placeholder="0" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 text-right font-mono focus:outline-none focus:border-blue-500" required></div>
                                </div>
                            </div>
                        </div>
                        <div id="transfer-target-group" class="hidden p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
                            <label class="block text-xs font-bold text-blue-400 uppercase mb-3">Transfer Destination</label>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div><select id="entry-acc-target" class="account-select w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 focus:outline-none focus:border-blue-500"></select></div>
                                <div class="flex gap-2">
                                    <div class="w-1/3"><select id="entry-curr-target" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-2 py-3 text-slate-200 text-center"><option value="IDR">IDR</option><option value="USD">USD</option></select></div>
                                    <div class="w-2/3"><input type="number" step="any" id="entry-amt-target" placeholder="Auto" class="w-full bg-slate-700 border border-slate-600 rounded-lg px-4 py-3 text-slate-200 text-right font-mono focus:outline-none focus:border-blue-500"></div>
                                </div>
                            </div>
                        </div>
                        <button type="submit" id="submit-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow-lg active:scale-95 transition mt-4">Save Transaction</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl p-6 w-full max-w-sm border border-slate-700 text-center">
            <h3 class="font-bold text-white mb-2">Confirm Delete</h3><p class="text-slate-300 mb-4 text-sm">Cannot undo.</p><div id="del-item-preview" class="bg-slate-900 p-3 rounded-lg mb-6 text-sm text-slate-400 border border-slate-800"></div>
            <div class="flex justify-end gap-3"><button id="del-cancel" class="px-4 py-2 bg-slate-700 text-white rounded-lg hover:bg-slate-600">Cancel</button><button id="del-confirm" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Delete</button></div>
        </div>
    </div>
    
    <div id="calendar-detail-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
        <div class="bg-slate-800 rounded-xl p-6 w-full max-w-md border border-slate-700 shadow-2xl">
            <div class="flex justify-between items-center mb-4"><h3 id="cal-detail-title" class="font-bold text-white"></h3><button id="cal-close" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div>
            <div id="cal-detail-content" class="max-h-[60vh] overflow-y-auto space-y-3 custom-scroll"></div>
        </div>
    </div>
    <div id="toast" class="hidden fixed top-5 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl border border-slate-600 z-50 flex items-center gap-3 min-w-[200px] justify-center transition-all duration-300 translate-y-[-100px] opacity-0"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- CONFIG ---
        const SPREADSHEET_ID = "1YRKJgR_VNFCJt3Vgtmkfdf28YZiE44BMNcFg-UGU7hY"; 
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwbehUoJwzW89PN55LIhR71TmMpExcblSIKDPmLLgWJ3iQjGLgSj5h9OxLcmBK6luB9BA/exec";
        const API_KEY = "AIzaSyCNMaR1CCsaGQbcSDzjsTeTCtdc42l35tc";

        // CONFIG STATE (Fetched from Sheet)
        let SYSTEM_CONFIG = { exp: [], inc: [], wallets: [], pin: null };

        let masterData = [], itemToDelete = null, sortState = {k:'date',o:'desc'}, calendarDate = new Date(), exchangeRate = 16000; 
        let isEditing = false, editItem = null;

        document.getElementById('entry-date').valueAsDate = new Date();

        // --- INIT LOAD ---
        loadSystemConfig();

        async function loadSystemConfig() {
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify({ action: 'getSystemConfig' }) });
                const result = await response.json();
                if (result.status === 'success') {
                    SYSTEM_CONFIG = result;
                    const walletOptions = SYSTEM_CONFIG.wallets.map(w => `<option value="${w}">${w}</option>`).join('');
                    document.querySelectorAll('.account-select').forEach(sel => sel.innerHTML = walletOptions);
                    updateCategoryOptions('expense');
                    document.getElementById('init-loader').classList.add('hidden');
                    checkAuth();
                } else throw new Error("Failed Config");
            } catch (e) { alert("Error connecting to server."); }
        }

        function checkAuth() {
            if(sessionStorage.getItem('auth')==='true') { document.getElementById('pin-modal').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); fetchData(); } 
            else document.getElementById('pin-modal').classList.remove('hidden'); 
        }

        document.getElementById('pin-form').addEventListener('submit',e=>{ 
            e.preventDefault(); 
            if(document.getElementById('pin-input').value === SYSTEM_CONFIG.pin){ 
                sessionStorage.setItem('auth','true'); document.getElementById('pin-modal').classList.add('hidden'); document.getElementById('main-content').classList.remove('hidden'); fetchData(); 
            } else document.getElementById('pin-error').textContent="Incorrect PIN";
        });
        document.getElementById('logout-btn').addEventListener('click', ()=>{ sessionStorage.removeItem('auth'); location.reload(); });

        document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', e => switchTab(e.target.id.replace('tab','view'))));
        function switchTab(viewId) {
            document.querySelectorAll('.tab-view').forEach(v=>v.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(t=>{t.classList.remove('tab-active','text-white','bg-blue-600','border-transparent'); t.classList.add('text-slate-400','border-transparent');});
            document.getElementById(viewId).classList.remove('hidden');
            const btn = document.getElementById(viewId.replace('view','tab'));
            if(btn) { btn.classList.add('tab-active','text-white','bg-blue-600','border-transparent'); btn.classList.remove('text-slate-400'); }
        }

        window.applyDatePreset = (type) => {
            const now = new Date(); let start, end;
            if(type === 'thisMonth') { start = new Date(now.getFullYear(), now.getMonth(), 1); end = new Date(now.getFullYear(), now.getMonth() + 1, 0); } 
            else if (type === 'lastMonth') { start = new Date(now.getFullYear(), now.getMonth() - 1, 1); end = new Date(now.getFullYear(), now.getMonth(), 0); } 
            else if (type === 'last30') { end = new Date(); start = new Date(); start.setDate(now.getDate() - 30); } 
            else if (type === 'thisYear') { start = new Date(now.getFullYear(), 0, 1); end = new Date(now.getFullYear(), 11, 31); }
            else if (type === 'clear') { document.getElementById('filter-start').value = ''; document.getElementById('filter-end').value = ''; renderAll(); 
                document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('preset-active')); return; }
            
            const fmtDate = (d) => d.toISOString().split('T')[0];
            document.getElementById('filter-start').value = fmtDate(start); document.getElementById('filter-end').value = fmtDate(end);
            renderAll();
            
            // Highlight active preset
            document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('preset-active'));
            if(event) event.target.classList.add('preset-active');
        };

        function updateCategoryOptions(type) {
            const sel = document.getElementById('entry-cat'); sel.innerHTML = '';
            let options = type === 'income' ? SYSTEM_CONFIG.inc : SYSTEM_CONFIG.exp;
            if (!options || options.length === 0) options = ["General"];
            options.forEach(cat => { const o = document.createElement('option'); o.value = cat; o.textContent = cat; sel.appendChild(o); });
            const otherOpt = document.createElement('option'); otherOpt.value = 'Other'; otherOpt.textContent = 'Other...'; sel.appendChild(otherOpt);
            document.getElementById('entry-cat-other').classList.add('hidden');
        }

        const typeRadios = document.getElementsByName('entry-type');
        typeRadios.forEach(r => r.addEventListener('change', () => { updateUIForType(document.querySelector('input[name="entry-type"]:checked').value); }));

        function updateUIForType(val) {
            const tg = document.getElementById('transfer-target-group'), cg = document.getElementById('category-group'), ls = document.getElementById('lbl-source-acc'), btn = document.getElementById('submit-btn');
            if(val === 'transfer') {
                tg.classList.remove('hidden'); cg.classList.add('hidden'); ls.textContent = "FROM / SOURCE";
                btn.innerHTML = `<span>${isEditing ? "Update Transfer" : "Process Transfer"}</span>`;
                btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2 mt-4";
            } else {
                tg.classList.add('hidden'); cg.classList.remove('hidden'); ls.textContent = "FROM / ACCOUNT";
                btn.innerHTML = `<span>${isEditing ? "Update Transaction" : "Save Transaction"}</span>`;
                updateCategoryOptions(val);
                if(val === 'income') btn.className = isEditing ? "w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2 mt-4" : "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2 mt-4";
                else btn.className = isEditing ? "w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2 mt-4" : "w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2 mt-4";
            }
        }
        document.getElementById('entry-cat').addEventListener('change', e => document.getElementById('entry-cat-other').classList.toggle('hidden', e.target.value!=='Other'));

        async function fetchData() {
            try {
                const base = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values`;
                const [inc, exp, rateData] = await Promise.all([
                    fetch(`${base}/Income!A2:F?key=${API_KEY}`).then(r=>r.json()),
                    fetch(`${base}/Expenses!A2:F?key=${API_KEY}`).then(r=>r.json()),
                    fetch(`${base}/Expenses!G1?key=${API_KEY}`).then(r=>r.json())
                ]);
                
                masterData = [];
                const parse = (rows, type) => {
                    if(!rows) return;
                    rows.forEach(r => {
                        if(!r[0]) return;
                        let amt = parseFloat(String(r[5] || '0').replace(/,/g, ''));
                        masterData.push({ type, date: r[0], desc: r[1], cat: r[2], acc: r[3], curr: r[4], amt: Math.abs(amt) });
                    });
                };
                parse(inc.values, 'income'); parse(exp.values, 'expense');
                if (rateData.values && rateData.values[0]) exchangeRate = parseFloat(rateData.values[0][0].replace(/,/g, '').replace(/[^\d.]/g, ''));
                
                // Populate Filters
                const cats = [...new Set(masterData.map(d=>d.cat))].sort(), accs = [...new Set(masterData.map(d=>d.acc))].sort();
                document.getElementById('filter-cat').innerHTML = '<option value="all">All Categories</option>' + cats.map(c=>`<option>${c}</option>`).join('');
                document.getElementById('filter-acc').innerHTML = '<option value="all">All Accounts</option>' + accs.map(a=>`<option>${a}</option>`).join('');
                renderAll();
            } catch(e) { showToast("Error loading data: " + e.message, 'error'); }
        }

        function renderAll() {
            const bals = {}; let incIDR=0, expIDR=0, incUSD=0, expUSD=0;
            masterData.forEach(d => {
                const k = `${d.acc}-${d.curr}`;
                if(!bals[k]) bals[k] = {n:d.acc, c:d.curr, v:0};
                if(d.type==='income') { 
                    bals[k].v += d.amt; 
                    if(d.cat !== 'Transfer' && d.cat !== 'Initial Balance') { if(d.curr==='IDR') incIDR+=d.amt; else incUSD+=d.amt; }
                } else { 
                    bals[k].v -= d.amt; 
                    if(d.cat !== 'Transfer') { if(d.curr==='IDR') expIDR+=d.amt; else expUSD+=d.amt; }
                }
            });
            
            document.getElementById('account-balances-container').innerHTML = Object.values(bals).sort((a,b)=>a.n.localeCompare(b.n)).map((b, idx) => {
                const isUSD = b.c === 'USD'; const id = `bal-${idx}`;
                return `<div class="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700 hover:border-slate-500 transition"><span class="text-sm text-slate-300 font-medium">${b.n}</span><span id="${id}" class="font-bold font-mono ${b.v>=0?'text-blue-400':'text-red-400'} ${isUSD ? 'cursor-pointer hover:underline' : ''}" onclick="${isUSD ? `toggleCurrency('${id}', ${b.v})` : ''}">${fmt(b.v, b.c)}</span></div>`;
            }).join('');

            const totalIncReal = incIDR + (incUSD * exchangeRate);
            const totalExpReal = expIDR + (expUSD * exchangeRate);
            const netCashFlowIDR = totalIncReal - totalExpReal;
            let totalAssetIDR = 0; Object.values(bals).forEach(b => { if(b.c==='IDR') totalAssetIDR+=b.v; if(b.c==='USD') totalAssetIDR+=(b.v*exchangeRate); });
            
            document.querySelector('#summary-income div:last-child').textContent = fmt(totalIncReal,'IDR');
            document.querySelector('#summary-expense div:last-child').textContent = fmt(totalExpReal,'IDR');
            document.querySelector('#summary-net div:last-child').textContent = fmt(netCashFlowIDR,'IDR');
            const netEl = document.querySelector('#summary-net div:last-child');
            netEl.className = `font-bold text-xl truncate ${netCashFlowIDR>=0?'text-blue-400':'text-red-400'}`;
            document.querySelector('#summary-wealth div:last-child').innerHTML = `<div class="flex justify-between items-start z-10 mb-2"><div class="text-xs text-blue-200 uppercase font-bold tracking-wider">Net Worth</div><div class="text-[10px] text-blue-100 bg-white/20 px-2 py-0.5 rounded backdrop-blur-md">1 USD = ${new Intl.NumberFormat('en-US').format(exchangeRate)}</div></div><div class="text-white font-bold text-xl truncate z-10">${new Intl.NumberFormat('en-US',{style:'currency',currency:'IDR',maximumFractionDigits:0}).format(totalAssetIDR)}</div><div class="absolute -bottom-2 -right-2 text-7xl text-white opacity-5"><i class="fas fa-wallet"></i></div>`;

            const s=document.getElementById('filter-search').value.toLowerCase(), start=document.getElementById('filter-start').value, end=document.getElementById('filter-end').value, fCat=document.getElementById('filter-cat').value, fAcc=document.getElementById('filter-acc').value;
            let filtered = masterData.filter(d => {
                if(start && d.date < start) return false; if(end && d.date > end) return false;
                if(fCat!=='all' && d.cat!==fCat) return false; if(fAcc!=='all' && d.acc!==fAcc) return false;
                if(s && !d.desc.toLowerCase().includes(s)) return false; return true;
            }).sort((a,b) => sortState.o==='asc' ? (a[sortState.k]>b[sortState.k]?1:-1) : (a[sortState.k]<b[sortState.k]?1:-1));

            document.getElementById('data-body').innerHTML = filtered.map(d => `
                <tr class="hover:bg-slate-800 transition border-b border-slate-800 last:border-0"><td class="px-6 py-4 text-sm text-slate-400 whitespace-nowrap">${d.date}</td><td class="px-6 py-4 text-sm text-slate-200 font-medium">${d.desc}</td><td class="px-6 py-4 text-sm text-slate-400"><span class="bg-slate-800 px-2 py-0.5 rounded text-xs border border-slate-700">${d.acc}</span></td><td class="px-6 py-4 text-sm text-slate-400">${d.cat}</td><td class="px-6 py-4 text-sm text-right font-mono ${d.type==='income'?'text-green-400':'text-red-400'}">${d.type==='income'?'+':'-'} ${fmt(d.amt,d.curr)}</td><td class="px-6 py-4 text-center"><div class="flex justify-center gap-2"><button class="text-slate-500 hover:text-blue-400 edit-btn transition" data-item='${JSON.stringify(d)}'><i class="fas fa-pencil-alt"></i></button><button class="text-slate-500 hover:text-red-400 del-btn transition" data-item='${JSON.stringify(d)}'><i class="fas fa-trash"></i></button></div></td></tr>
            `).join('');
            if(filtered.length===0) document.getElementById('data-body').innerHTML = '<tr><td colspan="6" class="text-center py-8 text-slate-500 text-sm">No data found</td></tr>';

            renderDaily(masterData); renderCalendar(masterData); updateChart(masterData);
        }

        window.toggleCurrency = (id, usdVal) => {
            const el = document.getElementById(id);
            if(el.textContent.includes('$')) { const idrVal = usdVal * exchangeRate; el.textContent = fmt(idrVal, 'IDR'); el.classList.add('text-yellow-400'); } else { el.textContent = fmt(usdVal, 'USD'); el.classList.remove('text-yellow-400'); }
        };

        function renderDaily(data) {
            const dly={}; data.filter(d=>d.type==='expense'&&d.cat!=='Transfer').forEach(d=>{ if(!dly[d.date]) dly[d.date]={idr:0,usd:0}; if(d.curr==='IDR') dly[d.date].idr+=d.amt; else dly[d.date].usd+=d.amt; });
            document.getElementById('daily-body').innerHTML = Object.keys(dly).sort().reverse().map(dt => `<tr class="hover:bg-slate-700/50 border-b border-slate-700"><td class="px-6 py-4 text-sm text-slate-300 font-medium">${dt}</td><td class="px-6 py-4 text-sm text-right text-red-400 font-mono">${dly[dt].idr>0?fmt(dly[dt].idr,'IDR'):'-'}</td><td class="px-6 py-4 text-sm text-right text-red-400 font-mono">${dly[dt].usd>0?fmt(dly[dt].usd,'USD'):'-'}</td></tr>`).join('');
        }

        function renderCalendar(data) {
            const g = document.getElementById('calendar-grid'); g.innerHTML = ''; const y=calendarDate.getFullYear(), m=calendarDate.getMonth(); document.getElementById('calendar-header').textContent = calendarDate.toLocaleString('default',{month:'long',year:'numeric'});
            for(let i=0; i<new Date(y,m,1).getDay(); i++) g.appendChild(document.createElement('div'));
            for(let d=1; d<=new Date(y,m+1,0).getDate(); d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, items = data.filter(i=>i.date===dateStr), el = document.createElement('div');
                el.className = "calendar-day bg-slate-900/50 border border-slate-700 rounded-lg p-1 flex flex-col items-center justify-start hover:bg-slate-800 transition active:scale-95"; 
                el.innerHTML = `<span class="text-[10px] text-slate-500 mb-1">${d}</span>`;
                if(items.length>0) { 
                    el.innerHTML += `<div class="flex gap-1 mt-auto pb-1">${items.some(x=>x.type==='income')?'<div class="h-1.5 w-1.5 rounded-full bg-green-500"></div>':''}${items.some(x=>x.type==='expense')?'<div class="h-1.5 w-1.5 rounded-full bg-red-500"></div>':''}</div>`; 
                    el.onclick = () => { 
                        document.getElementById('cal-detail-title').textContent = `${dateStr}`; 
                        document.getElementById('cal-detail-content').innerHTML = items.map(x=>`<div class="flex justify-between items-center p-3 bg-slate-950 rounded-xl border border-slate-800"><div><div class="text-sm text-white font-bold">${x.desc}</div><div class="text-xs text-slate-500">${x.cat}</div></div><div class="${x.type==='income'?'text-green-400':'text-red-400'} font-mono text-sm">${fmt(x.amt,x.curr)}</div></div>`).join(''); 
                        document.getElementById('calendar-detail-modal').classList.remove('hidden'); 
                    }; 
                }
                g.appendChild(el);
            }
        }
        document.getElementById('prev-month').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(masterData); });
        document.getElementById('next-month').addEventListener('click', ()=>{ calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(masterData); });
        document.getElementById('cal-close').addEventListener('click', ()=>document.getElementById('calendar-detail-modal').classList.add('hidden'));

        let myChart;
        function updateChart(data) {
            const curr = document.getElementById('chart-currency-toggle').value; const exps = data.filter(d=>d.type==='expense'&&d.curr===curr&&d.cat!=='Transfer'); const totals={}; exps.forEach(d=>totals[d.cat]=(totals[d.cat]||0)+d.amt);
            const ctx=document.getElementById('expense-pie-chart').getContext('2d'); if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {type:'doughnut',data:{labels:Object.keys(totals),datasets:[{data:Object.values(totals),backgroundColor:['#ef4444','#f97316','#eab308','#22c55e','#06b6d4','#3b82f6','#a855f7','#ec4899','#6366f1'],borderWidth:0}]},options:{plugins:{legend:{display:false}},cutout:'70%'}});
            document.getElementById('expense-details').innerHTML = Object.entries(totals).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<div class="flex justify-between text-xs py-2 border-b border-slate-800 last:border-0"><span class="text-slate-300">${k}</span><span class="font-mono text-slate-100">${fmt(v,curr)}</span></div>`).join('');
        }

        document.getElementById('add-entry-form').addEventListener('submit', e => {
            e.preventDefault(); const btn=document.getElementById('submit-btn'); const origTxt=btn.innerHTML; btn.innerHTML='<div class="loader"></div>'; btn.disabled=true;
            const type = document.querySelector('input[name="entry-type"]:checked').value, date=document.getElementById('entry-date').value, desc=document.getElementById('entry-desc').value;
            let payload = {};

            if(isEditing) {
                let cat = document.getElementById('entry-cat').value; if(cat==='Other') cat = document.getElementById('entry-cat-other').value;
                payload = { 
                    action: 'edit', 
                    oldSheetName: editItem.type==='income'?'Income':'Expenses', 
                    originalData: editItem,
                    newSheetName: type==='income'?'Income':'Expenses',
                    newData: { date, description: desc, category: cat, account: document.getElementById('entry-acc-source').value, currency: document.getElementById('entry-curr-source').value, amount: Math.abs(parseFloat(document.getElementById('entry-amt-source').value)) }
                };
            } else {
                if(type === 'transfer') {
                    const fromAmt = parseFloat(document.getElementById('entry-amt-source').value), toAmtInput = document.getElementById('entry-amt-target').value, toAmt = toAmtInput ? parseFloat(toAmtInput) : fromAmt;
                    if(document.getElementById('entry-acc-source').value === document.getElementById('entry-acc-target').value && document.getElementById('entry-curr-source').value === document.getElementById('entry-curr-target').value) { showToast("Accounts match!", 'error'); btn.innerHTML=origTxt; btn.disabled=false; return; }
                    payload = { action: 'transfer', date, description: desc, fromAccount: document.getElementById('entry-acc-source').value, fromCurrency: document.getElementById('entry-curr-source').value, fromAmount: Math.abs(fromAmt), toAccount: document.getElementById('entry-acc-target').value, toCurrency: document.getElementById('entry-curr-target').value, toAmount: Math.abs(toAmt) };
                } else {
                    let cat = document.getElementById('entry-cat').value; if(cat==='Other') cat = document.getElementById('entry-cat-other').value;
                    payload = { action: 'add', sheetName: type==='income'?'Income':'Expenses', date, description: desc, category: cat, account: document.getElementById('entry-acc-source').value, currency: document.getElementById('entry-curr-source').value, amount: Math.abs(parseFloat(document.getElementById('entry-amt-source').value)) };
                }
            }

            fetch(WEB_APP_URL, {method:'POST', body:JSON.stringify(payload)}).then(r=>r.json()).then(d => {
                if(d.status==='success') { showToast(d.message, 'success'); resetForm(); setTimeout(fetchData, 1500); } else throw new Error(d.message);
            }).catch(e => showToast("Error: "+e.message, 'error')).finally(() => { btn.innerHTML=origTxt; btn.disabled=false; });
        });

        function resetForm() {
            document.getElementById('add-entry-form').reset(); document.getElementById('entry-date').valueAsDate = new Date();
            isEditing=false; editItem=null; document.getElementById('form-title').textContent="New Entry"; document.getElementById('cancel-edit-btn').classList.add('hidden');
            document.querySelector('input[name="entry-type"][value="expense"]').checked = true; document.querySelector('input[name="entry-type"][value="expense"]').dispatchEvent(new Event('change'));
        }
        document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);

        document.addEventListener('click', e => {
            const btnEdit = e.target.closest('.edit-btn'), btnDel = e.target.closest('.del-btn');
            
            if(btnDel) { 
                itemToDelete = JSON.parse(btnDel.dataset.item); 
                document.getElementById('del-item-preview').innerHTML = `<div class="font-bold text-white">${itemToDelete.desc}</div><div class="${itemToDelete.type==='income'?'text-green-400':'text-red-400'}">${fmt(itemToDelete.amt, itemToDelete.curr)}</div>`; 
                document.getElementById('delete-modal').classList.remove('hidden'); 
            }
            
            if(btnEdit) {
                const item = JSON.parse(btnEdit.dataset.item);
                if(item.cat === 'Transfer') { showToast("Delete & recreate transfer.", 'error'); return; }
                isEditing=true; editItem=item; 
                document.getElementById('form-title').textContent="Edit Transaction"; document.getElementById('cancel-edit-btn').classList.remove('hidden'); switchTab('view-add');
                document.querySelector(`input[name="entry-type"][value="${item.type}"]`).checked = true; updateUIForType(item.type);
                document.getElementById('entry-desc').value = item.desc; document.getElementById('entry-date').value = item.date; 
                const catSelect = document.getElementById('entry-cat'); if([...catSelect.options].map(o=>o.value).includes(item.cat)) catSelect.value = item.cat; else { catSelect.value = 'Other'; document.getElementById('entry-cat-other').classList.remove('hidden'); document.getElementById('entry-cat-other').value = item.cat; }
                document.getElementById('entry-acc-source').value = item.acc; document.getElementById('entry-curr-source').value = item.curr; document.getElementById('entry-amt-source').value = item.amt;
            }
        });

        document.getElementById('del-cancel').addEventListener('click', ()=>document.getElementById('delete-modal').classList.add('hidden'));
        document.getElementById('del-confirm').addEventListener('click', ()=>{
            const btn = document.getElementById('del-confirm'); const origTxt = btn.textContent; btn.textContent='...';
            fetch(WEB_APP_URL, {
                method:'POST', 
                body:JSON.stringify({ action:'delete', sheetName: itemToDelete.type==='income'?'Income':'Expenses', originalData: itemToDelete })
            }).then(r=>r.json()).then(d => {
                document.getElementById('delete-modal').classList.add('hidden'); btn.textContent=origTxt; if(d.status==='success') { showToast("Deleted successfully", 'success'); fetchData(); } else showToast(d.message, 'error');
            });
        });

        function fmt(n, c) { return new Intl.NumberFormat('en-US', {style:'currency',currency:c,minimumFractionDigits:0,maximumFractionDigits:2}).format(n); }
        function showToast(m, type) { 
            const t=document.getElementById('toast'); 
            t.className = `fixed top-5 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-2xl border z-50 flex items-center gap-3 min-w-[200px] justify-center transition-all duration-300 translate-y-0 opacity-100 ${type==='error'?'bg-red-900/90 border-red-700 text-red-100':'bg-slate-800/90 border-slate-600 text-slate-100'}`;
            t.innerHTML = `${type==='error'?'<i class="fas fa-exclamation-circle"></i>':'<i class="fas fa-check-circle text-green-400"></i>'} <span>${m}</span>`;
            t.classList.remove('hidden'); 
            setTimeout(()=>{ t.classList.add('translate-y-[-100px]', 'opacity-0'); setTimeout(()=>t.classList.add('hidden'),300); }, 3000); 
        }
        
        ['filter-start','filter-end','filter-cat','filter-acc','filter-search'].forEach(i => document.getElementById(i).addEventListener('input', renderAll));
        document.getElementById('chart-currency-toggle').addEventListener('change', ()=>updateChart(masterData));
        document.querySelectorAll('.sortable').forEach(s => s.addEventListener('click', e => { sortState.k = e.target.dataset.sort; sortState.o = sortState.o==='asc'?'desc':'asc'; renderAll(); }));
        document.getElementById('export-btn').addEventListener('click', async () => { 
            const el = document.getElementById('view-dashboard');
            const c = await html2canvas(el, {backgroundColor:'#0f172a', scale:2}); 
            const a = document.createElement('a'); a.href=c.toDataURL('image/png'); a.download='finance_dashboard.png'; a.click(); 
        });
    });
    </script>
</body>
</html>
